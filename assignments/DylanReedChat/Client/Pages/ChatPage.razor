@page "/chat"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@implements IAsyncDisposable


@* a user has entered their name in the first input box of the chat component, when they focus on the message input, any
    other users connected to the server will see a message to the right of the Send button that says that users name is
    typing a message. *@

<section class="chat">
    <div id="messagesList" class="messages">
        <div class="other">
            <ul>
                @foreach (var message in messages)
                {
                    @if (!message.Contains($"{nameInput}:"))
                    {
                        <li>
                            @(message == null ? "" : message)
                        </li>
                    }
                }
            </ul>
        </div>

        <div class="recipient">
            <ul>
                @foreach (var message in messages)
                {
                    @if (message.Contains($"{nameInput}:"))
                    {
                        <li>
                            @(message == null ? "" : message)
                        </li>
                    }
                }
            </ul>
        </div>

    </div>

    <ul class="typing-indicators">
        @foreach (var indicator in typingIndicators)
        {

            <li class="indicator">
                <span>@indicator</span>
                <span class="dot-flashing"></span>
            </li>
        }
    </ul>

    <div class="chat-form">
        <div class="inputs">
            <div class="form-group">
                <label>Name:</label>
                <input @bind="nameInput" />
            </div>
            <div class="form-group">
                <label>Message:</label>
                <input @bind="messageInput" @onfocus="TypingIndicator" size='50' @onblur="RemoveTypingIndicator" />

            </div>
        </div>
        <button @onclick="Send" disabled="@(!IsConnected)">Send</button>
    </div>
</section>

@code {
    private HubConnection hubConnection;
    private List<string> messages = new List<string>();
    private List<string> typingIndicators = new List<string>();
    private string connectionId;
    private string nameInput;
    private string messageInput;

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
        .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
        .Build();

        hubConnection.On<string, string>
        ("ReceiveMessage", (name, message) =>
        {
            var msg = $"{name}: {message} {@DateTime.Now.ToString("h:mm tt")}";
            messages.Add(msg);
            messageInput = string.Empty;
            StateHasChanged();
        });
        hubConnection.On<string, string>("TypingIndicator", (name, msg) =>
        {
            var typingMessage = $"{name} {msg}";
            if (!typingIndicators.Contains(typingMessage) && nameInput.Length > 0)
            {
                typingIndicators.Add(typingMessage);
                StateHasChanged();
            }
            StateHasChanged();
        });
        hubConnection.On<string>("RemoveTypingIndicator", (name) =>
        {
            var typingMessage = $"{name} is typing";
            if (typingIndicators.Contains(typingMessage))
            {
                // remove the typing indicator from the list
                typingIndicators.Remove(typingMessage);
                StateHasChanged();
            }
            StateHasChanged();
        });
        await hubConnection.StartAsync();
    }

    async Task Send() =>
    await hubConnection.InvokeAsync("SendMessage", nameInput, messageInput);

    async Task TypingIndicator() =>
    await hubConnection.SendAsync("TypingIndicator", nameInput, "is typing");
    async Task RemoveTypingIndicator() =>
    await hubConnection.SendAsync("RemoveTypingIndicator", nameInput);

    public bool IsConnected =>
    hubConnection.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
